{% extends 'admin/base_site.html' %}
{% load static humanize %}

{% block title %}Bank Admin Dashboard - Executive Overview{% endblock %}

{% block extrahead %}
{{ block.super }}
{% if not bootstrap_missing %}
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
{% else %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% endif %}
<link href="{% static 'css/admin_dashboard.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Add animate.css for extra animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
    /* Additional custom animations */
    /* Full width enforcement */
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Remove any remaining side margins */
    .container-fluid {
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
    
    /* Ensure all rows are full width */
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100%;
    }
    
    /* Card enhancements */
    .card {
        border: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Enhanced gradients */
    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
    }
    
    /* Floating animation */
    @keyframes floating {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .floating {
        animation: floating 3s ease-in-out infinite;
    }
    
    /* Neon glow effect */
    .neon-glow {
        box-shadow: 0 0 20px rgba(26, 115, 232, 0.3),
                    0 0 40px rgba(26, 115, 232, 0.2),
                    0 0 60px rgba(26, 115, 232, 0.1);
    }
    
    /* Enhanced table */
    .table-enhanced {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        overflow: hidden;
    }
    
    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.5rem;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .animate-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease, transform 0.6s ease;
    }
    
    .animate-on-scroll.animated {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* Gradient text effects */
    .gradient-text {
        background: linear-gradient(45deg, var(--primary), var(--success));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Glass morphism effects */
    .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    
    /* Status indicators */
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        position: relative;
    }
    
    .status-indicator.active {
        background: var(--success);
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }
    
    .status-indicator.active::after {
        content: '';
        position: absolute;
        top: -3px;
        left: -3px;
        right: -3px;
        bottom: -3px;
        border-radius: 50%;
        border: 2px solid var(--success);
        animation: pulse-ring 2s infinite;
    }
    
    @keyframes pulse-ring {
        0% {
            transform: scale(0.8);
            opacity: 1;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }
    
    /* Full width adjustments */
    .dashboard-container {
        padding-left: 20px !important;
        padding-right: 20px !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    .main-content {
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    /* Hide the KPI blocks row */
    .row.g-4.mb-4:first-of-type {
        display: none !important;
    }

    /* Header card enhancements */
    .dashboard-header .header-card {
        background: linear-gradient(135deg, rgba(102,126,234,0.06), rgba(118,75,162,0.06));
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.06);
        border: 1px solid rgba(255,255,255,0.06);
    }

    .dashboard-header .title-block { flex: 1; min-width: 0; }
    .dashboard-title { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.5rem; margin-bottom: 0.25rem; }
    .dashboard-subtitle { margin: 0; color: #6c757d; }
    .dashboard-subtitle .subtitle-title { font-weight: 600; }
    .dashboard-subtitle .subtitle-desc { color: #868e96; font-size: 0.9rem; }

    /* Live datetime pill */
    .header-actions .live-pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.45rem 0.65rem; border-radius: 0.6rem; }

    /* Header buttons */
    .header-actions .btn-outline-primary { border-width: 1px; transition: transform .15s ease, box-shadow .15s ease; }
    .header-actions .btn-outline-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); }

    /* Status */
    .status-text { font-size: 0.9rem; color: #6c757d; margin-left: 6px; }

    /* Gradient divider */
    .gradient-divider {
        height: 6px;
        border-radius: 6px;
        background: linear-gradient(90deg, #ff5f6d, #ffc371, #8bd3dd, #7b7bff, #ff6bcb);
        background-size: 300% 100%;
        animation: gradientShift 6s linear infinite;
        margin-top: 1rem;
        box-shadow: 0 6px 20px rgba(123, 123, 255, 0.06);
    }
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Or if you want to hide just the KPI section */
    .dashboard-layout .main-content .row.g-4.mb-4:first-child {
        display: none !important;
    }
    .transaction-row {
  transition: background-color .2s ease, transform .2s ease;
}

.transaction-row:hover {
  background-color: rgba(13,110,253,.03);
}

.smaller {
  font-size: 0.75rem;
}

</style>
{% endblock %}

{% block content %}
<!-- Chart.js (local preferred, CDN fallback) -->
{% if not chartjs_missing %}
<script src="{% static 'js/chart.umd.min.js' %}"></script>
{% else %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
{% endif %}

<!-- Add particles.js for background effects -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<div class="container-fluid py-4 dashboard-container">
    <!-- Loading overlay shown while the dashboard fetches API data -->
    <div id="dashboard-loading" class="chart-loading-overlay animate__animated animate__fadeIn" 
         aria-hidden="false" role="status" aria-live="polite" style="display:none;">
      <div class="text-center">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status" aria-hidden="true"></div>
        <div class="mt-3">
          <h5 class="text-primary mb-2">Loading Executive Dashboard</h5>
          <p class="text-muted">Fetching real-time financial data...</p>
          <div class="progress" style="height: 6px; width: 200px; margin: 0 auto;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
    
  {% if assets_missing %}
  <div class="alert alert-warning alert-dismissible fade show glass-effect animate__animated animate__slideInDown" role="alert">
    <div class="d-flex align-items-center">
      <i class="fas fa-exclamation-triangle text-warning me-3 fa-2x"></i>
      <div>
        <strong class="d-block mb-1">Missing Assets Detected</strong>
        <span class="d-block">{{ assets_missing|join:", " }}. Using CDN fallbacks automatically.</span>
        <small class="text-muted d-block mt-1">
          For local copies, run: 
          <code class="ms-1">python manage.py fetch_bootstrap</code> and
          <code>python manage.py fetch_chartjs</code>
        </small>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}
  
  <!-- Header Section - Enhanced -->
  <div class="dashboard-header mb-5 animate__animated animate__fadeIn">
    <div class="header-card glass-effect p-3 p-md-4">
      <div class="d-flex align-items-center title-block">
        <div class="me-3 floating neon-glow d-none d-md-flex align-items-center justify-content-center" style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white; font-size:1.4rem;">
          <i class="fas fa-chart-line"></i>
        </div>
        <div>
          <h1 class="dashboard-title gradient-text mb-3">Bank Executive Dashboard</h1>
          <div class="dashboard-subtitle d-flex align-items-start gap-3">
            <div>
              <div class="subtitle-title fw-semibold">Real-time financial insights</div>
              <div class="subtitle-desc small text-muted">Predictive analytics &amp; performance monitoring</div>
            </div>
            <div class="d-none d-sm-block ms-3">
              <span class="badge bg-white text-dark small shadow-sm">Live</span>
              <span class="badge bg-light text-dark small ms-1">Updated Now</span>
            </div>
          </div>
        </div>
      </div>

      <div class="header-actions d-flex align-items-center ms-auto">
        <span id="live-datetime" class="badge bg-light text-dark me-3 live-pill glass-effect" role="note" aria-label="Current date and time">
          <i class="fas fa-clock me-2 text-primary"></i>
          <span id="live-date" class="me-2 fw-bold">12 Jan 2026</span>
          <span id="live-time" style="font-variant-numeric: tabular-nums;" class="text-primary fw-bold">18:22:37</span>
        </span>
        <!-- <div class="btn-group me-3">
          <a class="btn btn-outline-primary btn-sm me-2 hover-3d" href="{{ quick_links.users }}">
            <i class="fas fa-users me-1"></i> Users
          </a>
          <a class="btn btn-outline-primary btn-sm me-2 hover-3d" href="{{ quick_links.accounts }}">
            <i class="fas fa-credit-card me-1"></i> Accounts
          </a>
          <a class="btn btn-outline-primary btn-sm hover-3d" href="{{ quick_links.transactions }}">
            <i class="fas fa-exchange-alt me-1"></i> Transactions
          </a>
        </div> -->
        <div class="d-flex align-items-center">
          <span class="status-indicator active me-2"></span>
          <span class="small status-text text-muted">System Active</span>
        </div>
      </div>
    </div>

    <!-- Colorful gradient divider -->
    <div class="gradient-divider" aria-hidden="true"></div>
  </div>

  <!-- KPI Cards Section -->
  <div class="dashboard-layout d-lg-flex animate__animated animate__fadeInUp">
    <aside class="dashboard-sidebar d-none d-lg-block pe-3">
      <div class="card shadow-lg sidebar-card p-4 mb-4 hover-3d">
        <div class="d-flex align-items-center mb-3">
          <i class="fas fa-sliders-h text-primary me-2"></i>
          <h6 class="mb-0 fw-bold">Dashboard Controls</h6>
        </div>
        <div class="mb-4">
          <div class="small text-muted mb-2 d-flex align-items-center">
            <i class="fas fa-calendar me-1"></i>
            Time Range
          </div>
          <div class="btn-group-vertical w-100" role="group" aria-label="Range selector">
            <button class="btn btn-outline-primary btn-range mb-2 hover-3d" data-range="30">30 Days</button>
            <button class="btn btn-outline-primary btn-range mb-2 hover-3d" data-range="90">90 Days</button>
            <button class="btn btn-outline-primary btn-range mb-2 hover-3d" data-range="180">180 Days</button>
            <button class="btn btn-outline-primary btn-range mb-2 hover-3d" data-range="365">1 Year</button>
            <button class="btn btn-outline-primary btn-range hover-3d" data-range="all">All Time</button>
          </div>
        </div>
        <div class="mb-4">
          <div class="small text-muted mb-2 d-flex align-items-center">
            <i class="fas fa-filter me-1"></i>
            Transaction Type
          </div>
          <div class="btn-group-vertical w-100" role="group">
            <button class="btn btn-outline-success btn-tx-type active mb-2 hover-3d" data-tx="all">All Types</button>
            <button class="btn btn-outline-success btn-tx-type mb-2 hover-3d" data-tx="deposit">
              <i class="fas fa-arrow-down me-1"></i> Deposits
            </button>
            <button class="btn btn-outline-success btn-tx-type hover-3d" data-tx="withdrawal">
              <i class="fas fa-arrow-up me-1"></i> Withdrawals
            </button>
          </div>
        </div>
        <div class="mb-4">
          <div class="small text-muted mb-2 d-flex align-items-center">
            <i class="fas fa-chart-bar me-1"></i>
            Chart Display
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input btn-chart-toggle" type="checkbox" value="line" id="toggleLine" checked>
            <label class="form-check-label small" for="toggleLine">
              <i class="fas fa-chart-line me-1"></i> Transactions Chart
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input btn-chart-toggle" type="checkbox" value="pie" id="togglePie" checked>
            <label class="form-check-label small" for="togglePie">
              <i class="fas fa-chart-pie me-1"></i> Distribution Chart
            </label>
          </div>
        </div>
        <div class="mt-4">
          <button class="btn btn-primary btn-gradient w-100 hover-3d" id="refresh-dashboard">
            <i class="fas fa-sync-alt me-2"></i> Refresh Dashboard
          </button>
        </div>
      </div>
      
      <!-- Quick Stats Sidebar Card -->
      <div class="card shadow-lg sidebar-card p-4 hover-3d">
        <h6 class="mb-3 fw-bold text-center">Quick Stats</h6>
        <div class="text-center mb-3">
          <div class="display-4 fw-bold text-primary mb-1">{{ total_users|default:"0" }}</div>
          <div class="small text-muted">Active Users</div>
        </div>
        <div class="row text-center">
          <div class="col-6 mb-3">
            <div class="h4 fw-bold text-success mb-1">${{ total_deposits|default:"0"|floatformat:0 }}</div>
            <div class="small text-muted">Total Deposits</div>
          </div>
          <div class="col-6 mb-3">
            <div class="h4 fw-bold text-warning mb-1">${{ total_withdrawals|default:"0"|floatformat:0 }}</div>
            <div class="small text-muted">Total Withdrawals</div>
          </div>
        </div>
        <div class="text-center">
          <div class="small text-muted mb-1">System Uptime</div>
          <div class="h5 fw-bold text-success">99.9%</div>
        </div>
      </div>
    </aside>
    
    <div class="main-content flex-grow-1">
      <!-- Main content remains the same but enhanced with new classes -->
      <!-- KPI Cards Row -->
      {% if not hide_kpi_blocks %}
      <div class="row g-4 mb-4">
          {% include 'admin/includes/kpi_block.html' with 
              label='Total Users' 
              value=total_users 
              icon='users' 
              color='primary'
          %} 
          
          {% include 'admin/includes/kpi_block.html' with 
              label='Total Transactions' 
              value=total_transactions 
              icon='receipt' 
              color='secondary'
          %}
          
          {% include 'admin/includes/kpi_block.html' with 
              label='Total Deposits' 
              value=total_deposits|floatformat:2 
              icon='arrow-down' 
              color='info'
              prefix='$' 
          %}
          
          {% include 'admin/includes/kpi_block.html' with 
              label='Total Withdrawals' 
              value=total_withdrawals|floatformat:2 
              icon='arrow-up' 
              color='warning'
              prefix='$' 
          %}
      </div>
      {% endif %}

      <div class="row g-4 mb-4">
  <div class="col-lg-8">
    <div class="card shadow border-0 rounded-4 p-4 hover-3d">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h6 class="mb-0 d-flex align-items-center fw-semibold">
          <i class="fas fa-history text-primary fs-5 me-2"></i>
          Recent Transactions
        </h6>

        <span class="badge rounded-pill bg-primary-subtle text-primary px-3 py-2 fw-semibold">
          <i class="fas fa-bolt me-1"></i> Live
        </span>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table align-middle table-hover table-borderless mb-0">
          <thead class="table-light small text-muted">
            <tr>
              <th class="ps-4">Date & Time</th>
              <th>Transaction ID</th>
              <th>User</th>
              <th>Type</th>
              <th class="text-end pe-4">Amount</th>
            </tr>
          </thead>

          <tbody>
            {% for t in recent_transactions %}
            <tr class="transaction-row">

              <!-- Date -->
              <td class="ps-4">
                <div class="fw-semibold small">
                  {{ t.timestamp|date:"M d, Y" }}
                </div>
                <div class="text-muted smaller">
                  {{ t.timestamp|time:"H:i:s" }}
                </div>
              </td>

              <!-- ID -->
              <td>
                <code class="px-2 py-1 rounded bg-primary bg-opacity-10 text-primary fw-semibold">
                  {{ t.id|slice:"-8:"|upper }}
                </code>
              </td>

              <!-- User -->
              <td>
                <div class="d-flex align-items-center gap-2">
                  <div class="avatar-circle-sm rounded-circle d-flex align-items-center justify-content-center
                              bg-primary bg-opacity-10 text-primary fw-bold shadow-sm">
                    {{ t.account.user.email|first|upper }}
                  </div>
                  <span class="text-truncate small fw-medium" style="max-width: 160px;">
                    {{ t.account.user.email }}
                  </span>
                </div>
              </td>

              <!-- Type -->
              <td>
                <span class="badge rounded-pill px-3 py-2 fw-semibold
                  {% if t.transaction_type == 1 %}
                    bg-success-subtle text-success
                  {% else %}
                    bg-warning-subtle text-warning
                  {% endif %}
                ">
                  {% if t.transaction_type == 1 %}
                    <i class="fas fa-arrow-down me-1"></i> Deposit
                  {% else %}
                    <i class="fas fa-arrow-up me-1"></i> Withdrawal
                  {% endif %}
                </span>
              </td>

              <!-- Amount -->
              <td class="text-end pe-4">
                <span class="fw-bold fs-6
                  {% if t.transaction_type == 1 %}
                    text-success
                  {% else %}
                    text-warning
                  {% endif %}
                ">
                  ${{ t.amount|floatformat:2 }}
                </span>
              </td>

            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                <div class="fw-semibold">No recent transactions</div>
                <small>Transactions will appear here as they occur</small>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="mt-4 d-flex justify-content-between align-items-center">
        <small class="text-muted">
          Showing latest {{ recent_transactions|length }} transactions
        </small>

        <a class="btn btn-sm btn-outline-primary rounded-pill px-3 hover-3d"
           href="{% url 'admin:admin_dashboard_export_lists_csv' %}?list=recent_transactions">
          <i class="fas fa-file-export me-1"></i> Export CSV
        </a>
      </div>

    </div>
  </div>

        <div class="col-lg-4">
          <!-- Enhanced cards with hover effects -->
          <div class="card shadow border-0 rounded-4 mb-3 p-3 hover-3d">
  <div class="card-body p-2">

    <h6 class="mb-4 d-flex justify-content-between align-items-center fw-semibold">
      <span class="d-flex align-items-center gap-2">
        <i class="fas fa-user-plus text-success fs-5"></i>
        Recent Users
      </span>

      <a class="btn btn-sm btn-link text-decoration-none text-success p-0"
         href="{% url 'admin:admin_dashboard_export_lists_csv' %}?list=recent_users"
         data-bs-toggle="tooltip"
         title="Export CSV">
        <i class="fas fa-download fs-6"></i>
      </a>
    </h6>

    <ul class="list-unstyled mb-0">
      {% for u in recent_users %}
      <li class="py-3 px-2 border-bottom d-flex align-items-center rounded-3 hover-shadow-sm">

        <!-- Avatar -->
        <div class="avatar-circle-sm rounded-circle d-flex align-items-center justify-content-center
                    bg-success bg-opacity-10 text-success fw-bold me-3 shadow-sm">
          {{ u.email|first|upper }}
        </div>

        <!-- User Info -->
        <div class="flex-grow-1">
          <div class="small text-muted">
            Joined {{ u.date_joined|date:"M d, Y" }}
          </div>
          <div class="small fw-semibold text-dark">
            {{ u.email|truncatechars:24 }}
          </div>
        </div>

      </li>
      {% empty %}
      <li class="py-4 text-muted text-center">
        <i class="fas fa-users-slash fa-2x mb-2 opacity-50"></i>
        <div class="fw-medium">No new users</div>
      </li>
      {% endfor %}
    </ul>

  </div>
</div>


          <!-- <div class="card shadow-sm mb-3 p-3 hover-3d">
            <h6 class="mb-3 d-flex justify-content-between align-items-center">
              <span>
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                Users without account
              </span>
              <span class="badge bg-warning">{{ users_without_account_count }}</span>
            </h6>
            <ul class="list-unstyled mb-0">
              {% for u in users_without_account %}
              <li class="py-2 border-bottom d-flex align-items-center">
                <i class="fas fa-user-slash text-warning me-2"></i>
                {{ u.email }}
              </li>
              {% empty %}
              <li class="py-3 text-muted text-center">
                <i class="fas fa-check-circle text-success fa-lg mb-2"></i>
                <div>All users have accounts</div>
              </li>
              {% endfor %}
            </ul>
          </div> -->

          <div class="card shadow border-0 rounded-4 p-3 hover-3d">
  <div class="card-body p-2">

    <h6 class="mb-4 d-flex justify-content-between align-items-center fw-semibold">
      <span class="d-flex align-items-center gap-2">
        <i class="fas fa-trophy text-warning fs-5"></i>
        Top Users
      </span>
      <span class="badge rounded-pill bg-primary-subtle text-primary px-3 py-2">
        By Activity
      </span>
    </h6>

    <ul class="list-unstyled mb-0">
      {% for u in top_users %}
      <li class="py-3 px-2 border-bottom d-flex align-items-center rounded-3 hover-shadow-sm">
        
        <!-- Avatar -->
        <div class="avatar-circle-sm rounded-circle d-flex align-items-center justify-content-center 
                    bg-primary bg-opacity-10 text-primary fw-bold me-3 shadow-sm">
          {{ u.email|first|upper }}
        </div>

        <!-- User Info -->
        <div class="flex-grow-1">
          <div class="small fw-semibold text-dark">
            {{ u.email|truncatechars:24 }}
          </div>
          <div class="text-muted small">
            Active User
          </div>
        </div>

        <!-- Activity Badge -->
        <span class="badge rounded-pill bg-primary bg-opacity-10 
                     text-primary fw-semibold px-3 py-2">
          {{ u.tx_count }}
        </span>
      </li>
      {% empty %}
      <li class="py-4 text-muted text-center">
        <i class="fas fa-chart-bar fa-2x mb-2 opacity-50"></i>
        <div class="fw-medium">No activity yet</div>
      </li>
      {% endfor %}
    </ul>

  </div>
</div>

        </div>
      </div>

      <!-- Charts Section -->
      <div class="row g-4">
        <!-- Left Column: Charts -->
        <div class="col-lg-8">
          <!-- Transactions Chart Card -->
          <div class="card shadow-lg border-0 chart-card hover-3d">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
              <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-chart-line text-primary me-3 fa-lg"></i>
                <div>
                  <div class="fw-bold">Transaction Volume Analytics</div>
                  <small class="text-muted">Last {{ selected_range|default:"30" }} days performance</small>
                </div>
              </h5>
              <div class="chart-period-selector">
                <div class="btn-group btn-group-sm" role="group" aria-label="Range selector">
                  <a href="?range=30" class="btn btn-outline-primary {% if selected_range == '30' %}active{% endif %} hover-3d">30d</a>
                  <a href="?range=90" class="btn btn-outline-primary {% if selected_range == '90' %}active{% endif %} hover-3d">90d</a>
                  <a href="?range=180" class="btn btn-outline-primary {% if selected_range == '180' %}active{% endif %} hover-3d">180d</a>
                  <a href="?range=365" class="btn btn-outline-primary {% if selected_range == '365' %}active{% endif %} hover-3d">365d</a>
                  <a href="?range=all" class="btn btn-outline-primary {% if selected_range == 'all' %}active{% endif %} hover-3d">All</a>
                </div>
              </div>
            </div>
            <div class="card-body pt-0">
              <div class="chart-container">
                <canvas id="txChart" height="120"></canvas>
              </div>
              <div class="chart-stats mt-4">
                <div>
                  <span class="text-muted small d-block">Peak Volume</span>
                  <span class="fw-bold ms-2 text-primary">
                    <span class="kpi-prefix">$</span>
                    <span class="counter" data-format="currency">{{ peak_transaction|default:"0.00" }}</span>
                  </span>
                </div>
                <div>
                  <span class="text-muted small d-block">Avg Daily</span>
                  <span class="fw-bold ms-2 text-success">
                    <span class="kpi-prefix">$</span>
                    <span class="counter" data-format="currency">{{ avg_daily_transaction|default:"0.00" }}</span>
                  </span>
                </div>
                <div>
                  <span class="text-muted small d-block">Growth Rate</span>
                  <span class="fw-bold ms-2 text-success">
                    <i class="fas fa-arrow-up me-1"></i>
                    12.5%
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Deposits vs Withdrawals Card -->
          <div class="card shadow-lg border-0 mt-4 chart-card hover-3d">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
              <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-chart-pie text-success me-3 fa-lg"></i>
                <div>
                  <div class="fw-bold">Financial Distribution Analysis</div>
                  <small class="text-muted">Real-time cash flow overview</small>
                </div>
              </h5>
              <span class="badge bg-success bg-opacity-25 text-success px-3 py-2">
                <i class="fas fa-sync-alt me-1"></i>
                Current Month
              </span>
            </div>
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-7">
                  <div class="chart-container">
                    <canvas id="txPie" height="160"></canvas>
                  </div>
                </div>
                <div class="col-md-5">
                  <div class="distribution-stats">
                    <div class="stat-item d-flex align-items-center mb-3 p-3 bg-success bg-opacity-10 rounded">
                      <div class="stat-indicator bg-success me-3"></div>
                      <div>
                        <div class="text-muted small">Total Deposits</div>
                        <div class="h5 mb-0 text-success fw-bold">${{ total_deposits|floatformat:2 }}</div>
                      </div>
                    </div>
                    <div class="stat-item d-flex align-items-center mb-3 p-3 bg-warning bg-opacity-10 rounded">
                      <div class="stat-indicator bg-warning me-3"></div>
                      <div>
                        <div class="text-muted small">Total Withdrawals</div>
                        <div class="h5 mb-0 text-warning fw-bold">${{ total_withdrawals|floatformat:2 }}</div>
                      </div>
                    </div>
                    <div class="stat-item d-flex align-items-center p-3 bg-info bg-opacity-10 rounded">
                      <div class="stat-indicator bg-info me-3"></div>
                      <div>
                        <div class="text-muted small">Net Cash Flow</div>
                        <div class="h5 mb-0 {% if net_flow >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                          ${{ net_flow|default:"0.00"|floatformat:2 }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Actions & Top Accounts - Enhanced -->
        <div class="col-lg-4">
          <!-- User Search Card -->
          <div class="card shadow-lg border-0 action-card mb-4 hover-3d">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-search text-primary me-3"></i>
                <span>Advanced User Analytics</span>
              </h5>
            </div>
            <div class="card-body">
              <form class="user-search-form" method="get">
                <div class="input-group mb-4">
                  <span class="input-group-text bg-primary text-white">
                    <i class="fas fa-user"></i>
                  </span>
                  <input type="text" name="user_id" class="form-control" 
                         placeholder="Enter User ID or Email" 
                         value="{% if user_q %}{{ user_q.id }}{% endif %}">
                  <button class="btn btn-primary" type="submit">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </form>
              
              {% if user_q %}
              <div class="user-info mt-4 p-4 bg-light rounded">
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar-circle bg-primary text-white me-3 hover-3d">
                    {{ user_q.email|first|upper }}
                  </div>
                  <div>
                    <h6 class="mb-0 fw-bold">{{ user_q.email }}</h6>
                    <small class="text-muted">User ID: {{ user_q.id }}</small>
                  </div>
                </div>
                <div class="row text-center mt-3">
                  <div class="col-6">
                    <div class="small text-muted">Accounts</div>
                    <div class="h4 fw-bold text-primary">{{ user_accounts_count|default:"0" }}</div>
                  </div>
                  <div class="col-6">
                    <div class="small text-muted">Total Balance</div>
                    <div class="h4 fw-bold text-success">${{ user_total_balance|default:"0.00"|floatformat:2 }}</div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Quick Reports Card -->
          <div class="card shadow-lg border-0 action-card mb-4 hover-3d">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-file-export text-success me-3"></i>
                <span>Advanced Reports & Exports</span>
              </h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <a class="btn btn-outline-primary btn-action hover-3d" href="{{ quick_links.transactions }}">
                  <i class="fas fa-exchange-alt me-2"></i> View All Transactions
                </a>
                <a class="btn btn-outline-success btn-action hover-3d" href="{% url 'admin:admin_dashboard_export_all_csv' %}">
                  <i class="fas fa-file-csv me-2"></i> Export Full CSV Report
                </a>
                <a class="btn btn-outline-danger btn-action hover-3d" href="{% url 'admin:admin_dashboard_export_all_pdf' %}">
                  <i class="fas fa-file-pdf me-2"></i> Export Executive PDF
                </a>
              </div>
            </div>
          </div>

          <!-- Top Accounts Card -->
          <div class="card shadow-lg border-0 hover-3d">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span class="d-flex align-items-center">
                  <i class="fas fa-trophy text-warning me-3"></i>
                  <span>Top Performing Accounts</span>
                </span>
                <span class="badge bg-warning bg-opacity-25 text-warning px-3 py-2">
                  <i class="fas fa-chart-line me-1"></i>
                  By Balance
                </span>
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover table-borderless mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-4">User</th>
                      <th>Account</th>
                      <th class="text-end pe-4">Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for a in top_accounts %}
                    <tr class="account-row">
                      <td class="ps-4">
                        <div class="d-flex align-items-center">
                          <div class="avatar-circle-sm bg-primary bg-opacity-10 text-primary me-3">
                            {{ a.user.email|first|upper }}
                          </div>
                          <span class="text-truncate" style="max-width: 100px;">
                            {{ a.user.email }}
                          </span>
                        </div>
                      </td>
                      <td>
                        <code class="small bg-light px-2 py-1 rounded">{{ a.account_no|slice:"-6:" }}</code>
                      </td>
                      <td class="text-end pe-4">
                        <span class="badge balance-badge">
                          <i class="fas fa-dollar-sign me-1"></i>
                          {{ a.balance|floatformat:2|intcomma }}
                        </span>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="3" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-3 opacity-50"></i>
                        <div class="h5">No accounts found</div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden live region for screen readers to announce KPI updates -->
  <div id="kpi-live" class="visually-hidden" aria-live="polite"></div>

  <!-- Enhanced Footer -->
  <div class="dashboard-footer mt-5 pt-4 border-top">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h6 class="mb-3 d-flex align-items-center">
          <i class="fas fa-server me-2 text-primary"></i>
          System Status
        </h6>
        <div class="d-flex align-items-center">
          <span class="badge bg-success me-3 px-3 py-2">
            <i class="fas fa-circle me-1"></i> All Systems Operational
          </span>
          <div>
            <div class="small text-muted">Last updated</div>
            <div class="fw-bold">{{ current_time }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 text-md-end">
        <div class="text-muted small d-flex align-items-center justify-content-md-end">
          <i class="fas fa-shield-alt me-2 text-primary"></i>
          <div>
            <div class="fw-bold">Secure Banking System v2.4</div>
            <div class="small">Encrypted with AES-256</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JSON data blobs for client-side charts -->
<script type="application/json" id="chart-data">
{
  "dates": {{ chart_dates|default:'[]'|safe }},
  "totals": {{ chart_totals|default:'[]'|safe }},
  "pieLabels": {{ pie_labels|default:'[]'|safe }},
  "pieData": {{ pie_data|default:'[]'|safe }}
}
</script> 
<script>window.DASHBOARD_SELECTED_RANGE = '{{ selected_range|default:"30" }}';</script>

<!-- Bootstrap JS (local preferred, CDN fallback) -->
{% if not bootstrap_missing %}
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
{% else %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
{% endif %}
<script src="{% static 'js/admin_dashboard.js' %}"></script>

<!-- Initialize tooltips -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add scroll animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
            }
        });
    }, observerOptions);
    
    // Observe all animate-on-scroll elements
    document.querySelectorAll('.animate-on-scroll').forEach(el => {
        observer.observe(el);
    });
});
</script>
{% endblock %}